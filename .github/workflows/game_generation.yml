name: Bullet Chess Game Generation

on:
  # Allow manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration to run games (hours)'
        required: false
        default: '1'
      max_games:
        description: 'Maximum games to generate'
        required: false
        default: '100'
  
  # Optional: scheduled runs (commented out for now)
  # schedule:
  #   - cron: '0 */5 * * *'  # Every 5 hours

env:
  PYTHON_VERSION: '3.10'

jobs:
  generate_games:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours for testing
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Stockfish
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish
          which stockfish
          stockfish --version
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install python-chess numpy tqdm
      
      - name: Create directories
        run: |
          mkdir -p checkpoints
          mkdir -p game_batches
      
      - name: Download latest checkpoint (if available)
        run: |
          LATEST=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | grep '"tag_name"' | head -1 | cut -d'"' -f4)
          if [ ! -z "$LATEST" ]; then
            echo "Found latest release: $LATEST"
            curl -s https://api.github.com/repos/${{ github.repository }}/releases | grep '"browser_download_url"' | head -1 | cut -d'"' -f4 | wget -i - -O checkpoints/model.pt 2>/dev/null || echo "No checkpoint available"
          fi
          ls -lah checkpoints/ || echo "No checkpoints directory"
        continue-on-error: true
      
      - name: Run game generation
        run: |
          DURATION=${{ github.event.inputs.duration_hours || 1 }}
          MAX_GAMES=${{ github.event.inputs.max_games || 100 }}
          echo "Generating games for $DURATION hour(s), max $MAX_GAMES games"
          python game_player.py
        timeout-minutes: 90
        continue-on-error: true
      
      - name: Check generated games
        run: |
          if [ -d "game_batches" ] && [ -n "$(ls -A game_batches/)" ]; then
            echo "✅ Games generated successfully"
            ls -lah game_batches/
          else
            echo "⚠️ No games generated"
          fi
      
      - name: Upload game artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: game-batch-${{ github.run_number }}
          path: game_batches/
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Create release with games
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          files: game_batches/*
          tag_name: games-run-${{ github.run_number }}-${{ github.run_id }}
          body: |
            Auto-generated game batch from run #${{ github.run_number }}
            Time: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
